<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Resultados Eurovisi√≥n + Chat</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <h1>Resultados Finales</h1>
    <div id="resultados"></div>
    <div id="resumen" style="margin-top: 2rem;"></div>

    <hr style="margin: 2rem 0; border-color: #555;" />
    <h2>üí¨ Chat entre Usuarios</h2>
    <div>
      <label for="nombreUsuario">Tu nombre:</label>
      <input type="text" id="nombreUsuario" placeholder="Escribe tu nombre" />
    </div>
    <div id="chat" style="background:#1b263b; padding:1rem; border-radius:0.5rem; margin:1rem 0; max-height:300px; overflow-y:auto;"></div>
    <div>
      <input type="text" id="mensaje" placeholder="Escribe un mensaje..." />
      <button class="btn" onclick="enviarMensaje()">Enviar</button>
      <button class="btn" onclick="cargarChat()">Actualizar</button>
    </div>
  </div>

  <script>
    const votos1 = JSON.parse(localStorage.getItem("votos_usuario1")) || [];
    const votos2 = JSON.parse(localStorage.getItem("votos_usuario2")) || [];
    const top = JSON.parse(localStorage.getItem("top26_final")) || [];

    if (!votos1.length || !votos2.length || !top.length) {
      document.getElementById("resultados").innerHTML = "<p>Faltan datos.</p>";
    } else {
      const getPuntos = (votos, pais) => votos.find(v => v.pais === pais)?.puntos || '-';

      let dif1 = 0, dif2 = 0;
      let rows = "";
      top.sort((a, b) => a.posicion - b.posicion).forEach(entry => {
        const p = entry.pais;
        const pos = entry.posicion;
        const v1 = getPuntos(votos1, p);
        const v2 = getPuntos(votos2, p);

        const d1 = typeof v1 === 'number' ? Math.abs(v1 - pos) : "-";
        const d2 = typeof v2 === 'number' ? Math.abs(v2 - pos) : "-";

        if (typeof d1 === 'number') dif1 += d1;
        if (typeof d2 === 'number') dif2 += d2;

        rows += `<tr><td>${pos}</td><td>${p}</td><td>${v1}</td><td>${v2}</td></tr>`;
      });

      const tabla = `
        <table>
          <thead>
            <tr><th>Posici√≥n Final</th><th>Pa√≠s</th><th>Usuario 1</th><th>Usuario 2</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;
      document.getElementById("resultados").innerHTML = tabla;

      let ganador = dif1 < dif2 ? "üéâ Usuario 1 gana (m√°s cercano al ranking)" :
                    dif2 < dif1 ? "üéâ Usuario 2 gana (m√°s cercano al ranking)" : "ü§ù Empate";

      document.getElementById("resumen").innerHTML = `
        <p><strong>Diferencia total Usuario 1:</strong> ${dif1}</p>
        <p><strong>Diferencia total Usuario 2:</strong> ${dif2}</p>
        <p style="color: gold; font-weight: bold;">${ganador}</p>
      `;
    }

    function cargarChat() {
      const chatData = JSON.parse(localStorage.getItem("chat_mensajes")) || [];
      const chatBox = document.getElementById("chat");
      chatBox.innerHTML = chatData.map(msg => `<p><strong>${msg.usuario}:</strong> ${msg.texto}</p>`).join("");
    }

    function enviarMensaje() {
      const nombre = document.getElementById("nombreUsuario").value.trim();
      const mensaje = document.getElementById("mensaje").value.trim();
      if (!nombre || !mensaje) {
        alert("Debes escribir tu nombre y mensaje.");
        return;
      }
      const chatData = JSON.parse(localStorage.getItem("chat_mensajes")) || [];
      chatData.push({ usuario: nombre, texto: mensaje });
      localStorage.setItem("chat_mensajes", JSON.stringify(chatData));
      document.getElementById("mensaje").value = "";
      cargarChat();
    }

    // Cargar el chat al abrir la p√°gina
    window.onload = cargarChat;
  </script>
</body>
</html>
